const productData = {
  "i-educar": {
    title: "i-Educar",
    description:
      "O i-Educar é um software livre de gestão escolar que centraliza as informações de alunos, matrículas e turmas. Otimiza o trabalho da secretaria, garante dados precisos para a tomada de decisões e melhora a eficiência de toda a rede de ensino.",
    videoSrc: "video.mp4", // Placeholder video
    images: ["./YanTec_files/A1.Png", "./YanTec_files/ed.png"],
    details: [
      "Gestão de Matriculas e Turmas",
      "Histórico Escolar Digital",
      "Relatórios Gerenciais Completos",
      "Integração com Censo Escolar",
    ],
    link: "produtos.html#i-educar",
  },
  "e-diario": {
    title: "e-Diário",
    description:
      "Diário de classe eletrônico que permite aos professores registrarem notas, frequência e conteúdos de forma ágil. Totalmente integrado ao i-Educar, facilita o acompanhamento pedagógico e elimina o retrabalho com papéis.",
    videoSrc: "video.mp4",
    images: [
      "./YanTec_files/e-diario/ed1.webp",
      "./YanTec_files/e-diario/ed2.webp",
      "./YanTec_files/e-diario/ed3.webp",
      "./YanTec_files/e-diario/ed4.webp",
      "./YanTec_files/e-diario/ed5.webp",
      "./YanTec_files/e-diario/ed6.webp",
      "./YanTec_files/e-diario/ed7.webp",
      "./YanTec_files/e-diario/ed8.webp",
      "./YanTec_files/e-diario/ed9.webp",
      "./YanTec_files/e-diario/ed10.webp",
    ],
    details: [
      "Registro de Frequência e Notas",
      "Planejamento de Aulas",
      "Acesso via Dispositivos Móveis",
      "Comunicação com Pais e Alunos",
    ],
    link: "produtos.html#e-diario",
  },
  "e-comunidade": {
    title: "e-Comunidade",
    description:
      "Aplicativo que aproxima a escola da família. Pais e responsáveis acompanham a vida escolar do aluno, recebem comunicados, visualizam notas e frequência em tempo real, fortalecendo o vínculo com a instituição.",
    videoSrc: "video.mp4",
    images: [
      "./YanTec_files/e-comunidade/ec2.webp",
      "./YanTec_files/e-comunidade/ec3.webp",
      "./YanTec_files/e-comunidade/ec4.webp",
      "./YanTec_files/e-comunidade/ec5.webp",
      "./YanTec_files/e-comunidade/ec6.webp",
    ],
    details: [
      "Acompanhamento Escolar",
      "Notificações em Tempo Real",
      "Agenda Digital",
      "Canal de Comunicação Direta",
    ],
    link: "produtos.html#e-comunidade",
  },
  "innov-play": {
    title: "Innov Play",
    description:
      "Plataforma educacional gamificada que transforma o aprendizado em uma experiência envolvente. Utiliza elementos de jogos para motivar alunos, promover a competição saudável e reforçar o conteúdo de sala de aula.",
    videoSrc: "video.mp4",
    images: ["./YanTec_files/img-2.svg", "./YanTec_files/img-4.svg"],
    details: [
      "Trilhas de Aprendizagem Interativas",
      "Ranking e Recompensas",
      "Conteúdo Alinhado à BNCC",
      "Relatórios de Desempenho",
    ],
    link: "produtos.html#innov-play",
  },
  catracas: {
    title: "Catracas Escolares",
    description:
      "Sistema de controle de acesso seguro e automatizado. Integrado ao sistema escolar, monitora a entrada e saída de alunos, garantindo a segurança e notificando os pais em tempo real.",
    videoSrc: "video.mp4",
    images: ["./YanTec_files/img-3.svg"],
    details: [
      "Reconhecimento Facial ou Biometria",
      "Integração com i-Educar",
      "Bloqueio de Inadimplentes (opcional)",
      "Segurança Reforçada",
    ],
    link: "produtos.html#catracas",
  },
  laboratorios: {
    title: "Laboratórios Móveis",
    description:
      "Solução prática para levar tecnologia a qualquer sala de aula. Carrinhos de recarga equipados com dispositivos móveis (tablets/chromebooks) que facilitam a inclusão digital sem a necessidade de um laboratório fixo.",
    videoSrc: "video.mp4",
    images: ["./YanTec_files/img-4.svg"],
    details: [
      "Carrinho de Armazenamento e Recarga",
      "Dispositivos Robustos para Educação",
      "Mobilidade Total",
      "Fácil Gerenciamento",
    ],
    link: "produtos.html#laboratorios",
  },
  moveis: {
    title: "Móveis Escolares",
    description:
      "Mobiliário ergonômico e moderno, projetado para criar ambientes de aprendizagem colaborativos. Mesas, cadeiras e armários que se adaptam a diferentes layouts de sala de aula.",
    videoSrc: "video.mp4",
    images: ["./YanTec_files/img-2.svg"],
    details: [
      "Design Ergonômico",
      "Durabilidade e Resistência",
      "Cores Vibrantes e Modernas",
      "Configurações Flexíveis",
    ],
    link: "produtos.html",
  },
  "salas-google": {
    title: "Salas Google e Espaço Maker",
    description:
      "Ambientes de transformação digital e laboratórios de invenção. Une o poder dos Chromebooks e G Suite for Education com a criatividade da cultura Maker (impressão 3D, robótica), preparando alunos para o futuro.",
    videoSrc: "video.mp4",
    images: ["./YanTec_files/img-3.svg", "./YanTec_files/img-4.svg"],
    details: [
      "Chromebooks Gerenciados e Google Classroom",
      "Impressão 3D e Robótica",
      "Aprendizagem Baseada em Projetos (PBL)",
      "Estímulo à Criatividade e Colaboração",
    ],
    link: "produtos.html",
  },
  "sala-tea": {
    title: "Sala TEA",
    description:
      "Espaços especializados para o desenvolvimento de crianças com Transtorno do Espectro Autista. Equipadas com recursos sensoriais e pedagógicos selecionados para um atendimento inclusivo e eficiente.",
    videoSrc: "video.mp4",
    images: ["./YanTec_files/img-2.svg"],
    details: [
      "Recursos Sensoriais",
      "Material Pedagógico Adaptado",
      "Ambiente Acolhedor",
      "Foco na Inclusão",
    ],
    link: "produtos.html",
  },
};

/**
 * Toggles the expanded details view for a product.
 * @param {string} productId - The ID of the product.
 * @param {HTMLElement} element - The HTML element that triggered the event (the row or button).
 */
function toggleProductDetails(productId, element) {
  // 1. Close any currently open details
  const existingDetails = document.querySelectorAll(
    ".product-details-expanded"
  );
  let isSameProduct = false;

  existingDetails.forEach((detail) => {
    if (detail.getAttribute("data-product-id") === productId) {
      isSameProduct = true;
    }
    // Smooth close for switching
    const $detail = $(detail);
    const $content = $detail.find(".animate-fade-in-up");

    $content
      .removeClass("animate-fade-in-up")
      .addClass("animate-fade-out-down");

    setTimeout(() => {
      $detail.slideUp(500, function () {
        $(this).remove();
      });
    }, 350);
  });

  // If we clicked the same product that was open, we leave it closed (toggle behavior).
  if (isSameProduct) return;

  const product = productData[productId];
  if (!product) return;

  // 2. Find where to insert
  let injectionTarget = null;

  if (element) {
    const $el = $(element);

    // CHECK IF GRID ITEM
    const $gridItem = $el.closest(".solution-grid-item");

    if ($gridItem.length > 0) {
      // --- GRID LOGIC ---
      // Find the last item in the *current visual row* to insert after
      const container = $gridItem.parent();
      const items = container.children(".solution-grid-item");
      const itemIndex = items.index($gridItem);
      const topOffset = $gridItem.offset().top;

      let lastItemInRow = $gridItem;

      // Loop through subsequent items
      for (let i = itemIndex + 1; i < items.length; i++) {
        const $nextItem = $(items[i]);
        // Check if on same row (tolerance of 5px)
        if (Math.abs($nextItem.offset().top - topOffset) < 5) {
          lastItemInRow = $nextItem;
        } else {
          break; // Found start of next row
        }
      }
      injectionTarget = lastItemInRow;
    } else {
      // --- STANDARD LIST LOGIC (Produtos Page) ---
      injectionTarget = $el.closest(".row.product-row");
      if (injectionTarget.length === 0) injectionTarget = $el.closest(".row"); // Fallback
    }
  } else {
    injectionTarget = $("#" + productId);
  }

  if (!injectionTarget || injectionTarget.length === 0) {
    console.error("Target row not found for " + productId);
    return;
  }

  // --- Icon Logic ---
  // Reset all icons: Remove rotation
  $(".transition-icon").removeClass("rotate-180");

  // Find button in original element (button itself or inside row)
  let btnIcon;
  if (element) {
    btnIcon = $(element).find("i.transition-icon"); // If element is the card/row
    if (btnIcon.length === 0)
      btnIcon = $(element).closest(".card").find("i.transition-icon"); // If button inside card
    if (btnIcon.length === 0) btnIcon = $(element).find(".btn i"); // Fallback
  }

  if (btnIcon && btnIcon.length) {
    btnIcon.addClass("rotate-180");
  }
  // ------------------

  // 3. Build the HTML
  let detailsListHtml = "";
  if (product.details) {
    product.details.forEach((detail) => {
      detailsListHtml += `
                <li class="list-group-item border-0 px-0 mb-1 bg-transparent">
                    <i class="fa-solid fa-check text-success me-2"></i> ${detail}
                </li>`;
    });
  }

  // 3. Build the Grid Gallery HTML (No more carousel)
  let galleryHtml = "";

  if (product.images && product.images.length > 0) {
    let gridItems = "";

    // Show up to 8 images maximum
    const maxImages = 8;
    const displayImages = product.images.slice(0, maxImages);

    displayImages.forEach((imgSrc, index) => {
      gridItems += `
                <div class="gallery-item" onclick="openLightbox(${index}, '${productId}')">
                    <img src="${imgSrc}" loading="lazy" alt="${
        product.title
      } - Foto ${index + 1}">
                    <div class="gallery-overlay">
                        <i class="fa-solid fa-expand"></i>
                    </div>
                </div>
            `;
    });

    galleryHtml = `
            <div class="gallery-grid">
                ${gridItems}
            </div>
            ${
              product.images.length > maxImages
                ? `<div class="text-center mt-3"><small class="text-muted">+ ${
                    product.images.length - maxImages
                  } fotos não exibidas</small></div>`
                : ""
            }
        `;
  } else {
    galleryHtml = '<p class="text-muted">Nenhuma imagem disponível.</p>';
  }

  // Determine wrapper class: col-12 for generic full-width injection
  const html = `
        <div class="col-12 product-details-expanded" data-product-id="${productId}" style="display:none; overflow:hidden;">
            <div class="bg-white rounded-4 p-4 p-lg-5 my-3 shadow-inner position-relative text-left animate-fade-in-up border border-1">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" onclick="closeProductDetails(this)" aria-label="Close"></button>
                
                <div class="row g-4">
                    <!-- Left: Video -->
                    <div class="col-lg-6">
                        <h4 class="fw-bold mb-3 d-lg-none text-primary-yan">${product.title}</h4>
                        <div class="ratio ratio-16x9 rounded-4 overflow-hidden shadow-sm">
                            <video controls class="w-100 h-100" style="object-fit: cover;">
                                <source src="${product.videoSrc}" type="video/mp4">
                                Seu navegador não suporta a tag de vídeo.
                            </video>
                        </div>
                    </div>

                    <!-- Right: Details -->
                    <div class="col-lg-6">
                         <h3 class="fw-bold mb-3 d-none d-lg-block text-primary-yan">${product.title}</h3>
                         <p class="fs-5 justify" style="color: #374151;">${product.description}</p>
                         
                         <h6 class="fw-bold text-dark mt-4 mb-3">Principais Características:</h6>
                         <ul class="list-group mb-4">
                            ${detailsListHtml}
                         </ul>
                    </div>
                </div>

                <!-- Bottom: Gallery Grid -->
                <div class="row">
                    <div class="col-12">
                         <h5 class="fw-bold text-secondary mt-5 mb-3"><i class="fa-regular fa-images me-2"></i>Galeria de Fotos</h5>
                         ${galleryHtml}
                    </div>
                </div>
            </div>
        </div>
    `;

  // Inject and slide down (using insertAfter)
  // IMPORTANT: Note that we changed the outer wrapper to NOT be a 'row' but a 'col-12'.
  // If we are in grid, we insert after a 'col'. If we are in product list, we insert after a 'row'.

  // Adjustment to ensure compatibility with both:
  // If NOT grid, we likely want a ROW wrapper.
  // If GRID, we want a COL-12 wrapper (implied row is the parent).

  let finalHtml = html;
  const $gridItem = $(element).closest(".solution-grid-item"); // Re-check for grid item
  if ($gridItem.length === 0) {
    // List Mode: Restore ROW wrapper
    finalHtml = `
            <div class="row product-details-expanded" data-product-id="${productId}" style="display:none; overflow:hidden;">
                <div class="col-12">
                    <div class="bg-white rounded-4 p-4 p-lg-5 my-3 shadow-inner position-relative text-left animate-fade-in-up border border-1">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-3" onclick="closeProductDetails(this)" aria-label="Close"></button>
                        
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <h4 class="fw-bold mb-3 d-lg-none text-primary-yan">${product.title}</h4>
                                <div class="ratio ratio-16x9 rounded-4 overflow-hidden shadow-sm">
                                    <video controls class="w-100 h-100" style="object-fit: cover;">
                                        <source src="${product.videoSrc}" type="video/mp4">
                                        Seu navegador não suporta a tag de vídeo.
                                    </video>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                 <h3 class="fw-bold mb-3 d-none d-lg-block text-primary-yan">${product.title}</h3>
                                 <p class="fs-5 justify" style="color: #374151;">${product.description}</p>
                                 <h6 class="fw-bold text-dark mt-4 mb-3">Principais Características:</h6>
                                 <ul class="list-group mb-4">${detailsListHtml}</ul>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                 <h5 class="fw-bold text-secondary mt-5 mb-3"><i class="fa-regular fa-images me-2"></i>Galeria de Fotos</h5>
                                 ${galleryHtml}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
  }

  $(finalHtml)
    .insertAfter(injectionTarget)
    .slideDown(500, function () {
      // Scroll to the new section if needed, nicely
      $("html, body").animate(
        {
          scrollTop: $(this).offset().top - 150,
        },
        500
      );
    });
}

function closeProductDetails(btn) {
  // Reset all icons when closing via X
  $(".transition-icon").removeClass("rotate-180");

  const container = $(btn).closest(".product-details-expanded");
  const content = container.find(".animate-fade-in-up");

  // Apply reverse animation
  content.removeClass("animate-fade-in-up").addClass("animate-fade-out-down");

  // Wait for animation to finish then slide up
  setTimeout(() => {
    container.slideUp(500, function () {
      $(this).remove();
    });
  }, 350); // Slightly less than animation duration to overlap ensuring no gap
}

/**
 * Opens the Product Modal (Preview Mode) for index.html
 * @param {string} productId - The ID of the product.
 */
function openProductModal(productId) {
  const product = productData[productId];
  if (!product) return;

  // 1. Populate Text Content
  $("#modalTitle").text(product.title);
  $("#modalDescription").text(product.description);

  // 2. Populate Details List
  const $detailsList = $("#modalDetails");
  $detailsList.empty();
  if (product.details) {
    product.details.forEach((detail) => {
      $detailsList.append(
        `<li class="list-group-item border-0 p-0 mb-1"><i class="fa-solid fa-check text-primary-yan me-2"></i>${detail}</li>`
      );
    });
  }

  // 3. Populate Carousel
  const $carouselInner = $("#modalCarouselInner");
  $carouselInner.empty();

  if (product.images && product.images.length > 0) {
    product.images.forEach((img, index) => {
      const activeClass = index === 0 ? "active" : "";
      // Use contain for full visibility of images
      const slideHtml = `
                <div class="carousel-item ${activeClass} h-100">
                    <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                        <img src="${img}" class="d-block mw-100 mh-100" alt="${product.title}" style="object-fit: contain;">
                    </div>
                </div>
            `;
      $carouselInner.append(slideHtml);
    });

    // Show/Hide controls based on image count
    if (product.images.length > 1) {
      $(".modal-carousel-control").show();
    } else {
      $(".modal-carousel-control").hide();
    }
  }

  // 4. Setup "Ver Detalhes" Button
  const $linkBtn = $("#modalLink");
  if (product.link) {
    $linkBtn.attr("href", product.link);
    $linkBtn.html(`Ver Detalhes <i class="fa-solid fa-arrow-right ms-2"></i>`); // Update text as requested
    $linkBtn.show();
  } else {
    $linkBtn.hide();
  }

  // 5. Show Modal
  const modal = new bootstrap.Modal(document.getElementById("productModal"));
  modal.show();
}

// --- Lightbox Logic ---
let currentLightboxImages = [];
let currentLightboxIndex = 0;

function openLightbox(index, productId) {
    const product = productData[productId];
    if (!product || !product.images) return;

    currentLightboxImages = product.images;
    currentLightboxIndex = index;

    // Create Modal if not exists
    if ($('#lightboxModal').length === 0) {
        $('body').append(`
            <div id="lightboxModal" class="lightbox-modal">
                <div class="lightbox-close" onclick="closeLightboxModal()">&times;</div>
                <div class="lightbox-nav lightbox-prev" onclick="changeLightboxImage(-1)">&#10094;</div>
                <div class="lightbox-nav lightbox-next" onclick="changeLightboxImage(1)">&#10095;</div>
                <div class="lightbox-content">
                    <img id="lightboxImg" class="lightbox-image" src="" alt="Full view">
                    <div id="lightboxCaption" class="lightbox-caption"></div>
                </div>
            </div>
        `);
        
        // Keydown listener for arrows/esc
        $(document).on('keydown', function(e) {
            if ($('#lightboxModal').hasClass('active')) {
                if (e.key === 'Escape') closeLightboxModal();
                if (e.key === 'ArrowLeft') changeLightboxImage(-1);
                if (e.key === 'ArrowRight') changeLightboxImage(1);
            }
        });
    }

    updateLightboxImage();
    $('#lightboxModal').addClass('active');
}

function closeLightboxModal() {
    $('#lightboxModal').removeClass('active');
}

function changeLightboxImage(direction) {
    currentLightboxIndex += direction;
    // Loop
    if (currentLightboxIndex < 0) currentLightboxIndex = currentLightboxImages.length - 1;
    if (currentLightboxIndex >= currentLightboxImages.length) currentLightboxIndex = 0;
    
    updateLightboxImage();
}

function updateLightboxImage() {
    const src = currentLightboxImages[currentLightboxIndex];
    const $img = $('#lightboxImg');
    
    // Simple fade for transition
    $img.fadeOut(200, function() {
        $(this).attr('src', src).fadeIn(200);
    });
    
    $('#lightboxCaption').text(`${currentLightboxIndex + 1} / ${currentLightboxImages.length}`);
}
